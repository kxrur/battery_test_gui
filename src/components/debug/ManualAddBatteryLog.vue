<script setup lang="ts">
import { ref } from "vue";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "vue-sonner";

// Import the commands if they're available in your setup
import { commands } from "@/bindings"; // Adjust the import path as needed

const isLoading = ref(false);

const states = ["charging", "discharging", "idle", "maintenance", "error"];

const statuses = ["active", "inactive", "completed", "failed"];

const ports = ["COM1", "COM2", "COM3", "USB1", "USB2"];

const formData = ref({
  id: 0,
  port: ports[0],
  temperature: 0,
  battery_temperature: 0,
  electronic_load_temperature: 0,
  voltage: 0,
  current: 0,
  state: states[0],
  status: statuses[0],
});

const initialFormData = formData.value;

const handleSubmit = async () => {
  isLoading.value = true;

  try {
    const result = await commands.insertBatteryLog({
      record_id: null,
      id: formData.value.id,
      port: formData.value.port,
      bench_temperature_mosfet: formData.value.temperature,
      bench_temperature_resistor: formData.value.temperature + 10,
      battery_temperature: formData.value.battery_temperature,
      load: formData.value.electronic_load_temperature,
      voltage: formData.value.voltage,
      current: formData.value.current,
      state: formData.value.state,
      status: formData.value.status,
      start_date: null,
      end_date: null,
      test_id: 1,
    });

    if (result.status === "ok") {
      toast("Battery log saved", {
        description: "Saved successfully to the database.",
      });

      // Reset form
      formData.value = initialFormData;
    } else {
      toast("Error saving log", {
        description: result.error ?? "Unknown database error.",
      });
    }
  } catch (error) {
    toast("Submission error", {
      description:
        error instanceof Error
          ? error.message
          : "An unexpected error occurred.",
    });
  } finally {
    isLoading.value = false;
  }
};
</script>

<template>
  <div>
    <form @submit.prevent="handleSubmit" class="space-y-4">
      <div>
        <Label for="id">Battery ID</Label>
        <Input id="id" v-model.number="formData.id" type="number" placeholder="Enter battery ID" required />
      </div>

      <div>
        <Label for="port">Port</Label>
        <Select v-model="formData.port" required>
          <SelectTrigger>
            <SelectValue placeholder="Select a port" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem v-for="port in ports" :key="port" :value="port">
              {{ port }}
            </SelectItem>
          </SelectContent>
        </Select>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <Label for="temperature">Temperature (°C)</Label>
          <Input id="temperature" v-model.number="formData.temperature" type="number" step="0.1" placeholder="0.0"
            required />
        </div>

        <div>
          <Label for="battery_temperature">Battery Temp (°C)</Label>
          <Input id="battery_temperature" v-model.number="formData.battery_temperature" type="number" step="0.1"
            placeholder="0.0" required />
        </div>
      </div>

      <div>
        <Label for="electronic_load_temperature">Electronic Load Temp (°C)</Label>
        <Input id="electronic_load_temperature" v-model.number="formData.electronic_load_temperature" type="number"
          step="0.1" placeholder="0.0" required />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <Label for="voltage">Voltage (V)</Label>
          <Input id="voltage" v-model.number="formData.voltage" type="number" step="0.01" placeholder="0.00" required />
        </div>

        <div>
          <Label for="current">Current (A)</Label>
          <Input id="current" v-model.number="formData.current" type="number" step="0.01" placeholder="0.00" required />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <Label for="state">State</Label>
          <Select v-model="formData.state" required>
            <SelectTrigger>
              <SelectValue placeholder="Select state" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem v-for="state in states" :key="state" :value="state">
                {{ state }}
              </SelectItem>
            </SelectContent>
          </Select>
        </div>

        <div>
          <Label for="status">Status</Label>
          <Select v-model="formData.status" required>
            <SelectTrigger>
              <SelectValue placeholder="Select status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem v-for="status in statuses" :key="status" :value="status">
                {{ status }}
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      <Button type="submit" class="w-full" :disabled="isLoading">
        <span v-if="isLoading">Saving...</span>
        <span v-else>Save Battery Log</span>
      </Button>
    </form>
  </div>
</template>
